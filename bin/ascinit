#!/bin/bash
#
# ascinit - initialize Asciiville configuration files
#
# Setup default tmux configuration for this user
# Install required pip modules if not already installed
CONFDIR=/usr/share/doc/asciiville
BOLD=$(tput bold)
NORMAL=$(tput sgr0)

# Mutt configuration user setup
[ -f ${CONFDIR}/mutt/muttrc ] && {
  [ -d ${HOME}/.mutt ] || {
    mkdir ${HOME}/.mutt
    chmod 750 ${HOME}/.mutt
  }
  [ -d ${HOME}/.mutt/cache ] || {
    mkdir ${HOME}/.mutt/cache
    chmod 750 ${HOME}/.mutt/cache
  }
  [ -d ${HOME}/.mutt/cache/headers ] || {
    mkdir ${HOME}/.mutt/cache/headers
    chmod 750 ${HOME}/.mutt/cache/headers
  }
  [ -d ${HOME}/.mutt/cache/bodies ] || {
    mkdir ${HOME}/.mutt/cache/bodies
    chmod 750 ${HOME}/.mutt/cache/bodies
  }
  [ -f ${HOME}/.mutt/certificates ] || {
    touch ${HOME}/.mutt/certificates
    chmod 640 ${HOME}/.mutt/certificates
  }
  [ -f ${HOME}/.mutt/muttrc ] || {
    cp ${CONFDIR}/mutt/muttrc ${HOME}/.mutt/muttrc
    chmod 600 ${HOME}/.mutt/muttrc
    echo "A basic ${HOME}/.mutt/muttrc Mutt email client configuration"
    echo "has been created for you. The default configuration can be used"
    echo "as a template to create a GMail IMAP Mutt email account."
    echo "Edit ${HOME}/.mutt/muttrc and add your GMail credentials."
    echo ""
    echo "Several more extensive Mutt configurations are included in Asciiville."
    echo "See the folders:"
    printf "\t${CONFDIR}/mutt/\nand\n\t${CONFDIR}/mutt_multiple/\n"
    echo ""
    echo "A good starting point for the new Mutt user is the Mutt Wiki at:"
    echo "https://gitlab.com/muttmua/mutt/-/wikis/home"
  }
  [ -f ${HOME}/.mutt/colors ] || {
    cp ${CONFDIR}/mutt/colors ${HOME}/.mutt/colors
    chmod 640 ${HOME}/.mutt/colors
  }
}

# Setup default rifle configuration for this user unless one exists
[ -f ${CONFDIR}/rifle.conf ] && {
  [ -f ${HOME}/.config/ranger/rifle.conf ] || {
    [ -d ${HOME}/.config ] || mkdir -p ${HOME}/.config
    [ -d ${HOME}/.config/ranger ] || mkdir -p ${HOME}/.config/ranger
    cp ${CONFDIR}/rifle.conf ${HOME}/.config/ranger/rifle.conf
  }
}

# Setup default rainbowstream configuration for this user unless one exists
[ -f ${CONFDIR}/rainbow_config.json ] && {
  [ -f ${HOME}/.rainbow_config.json ] || {
    cp ${CONFDIR}/rainbow_config.json ${HOME}/.rainbow_config.json
  }
}

# Setup default tmux configuration for this user unless
# terminal-overrides has already been set
[ -f ${CONFDIR}/tmux.conf ] && {
  if [ -f ${HOME}/.tmux.conf ]
  then
    grep terminal-overrides ${HOME}/.tmux.conf > /dev/null || {
      cat ${CONFDIR}/tmux.conf >> ${HOME}/.tmux.conf
    }
  else
    cat ${CONFDIR}/tmux.conf >> ${HOME}/.tmux.conf
  fi
}

have_pip=`type -p pip`
[ "${have_pip}" ] || {
  plat=`uname -s`
  if [ "$plat" == "Darwin" ]
  then
    python3 -m ensurepip --upgrade
  else
    debian=
    [ -f /etc/os-release ] && . /etc/os-release
    [ "${ID_LIKE}" == "debian" ] && debian=1
    [ "${debian}" ] || [ -f /etc/debian_version ] && debian=1

    if [ "${debian}" ]
    then
      sudo apt install python3-pip
    else
      sudo dnf install python3-pip
    fi
  fi
}

pip list | grep asciimatics > /dev/null || python3 -m pip install asciimatics
pip list | grep rainbowstream > /dev/null || python3 -m pip install rainbowstream

create_new_profile() {
  local proname="$1"
  if [ "${proname}" == "gnome" ]
  then
    local profile_ids=($(dconf list $dconfdir/ | grep ^: |\
        sed 's/\///g' | sed 's/://g'))
  fi
  if [ "${proname}" == "tilix" ]
  then
    local profile_ids=($(dconf list $dconfdir/ | grep -v ^list |\
        sed 's/\///g' | sed 's/://g'))
  fi
  local profile_ids_old="$(dconf read "$dconfdir"/list | tr -d "]")"
  local profile_id="$(uuidgen)"

  [ -z "$profile_ids_old" ] && {
    local profile_ids_old="["  # if there's no `list` key
  }
  [ ${#profile_ids[@]} -gt 0 ] && local delimiter=,  # if the list is empty
  dconf write $dconfdir/list \
      "${profile_ids_old}${delimiter} '$profile_id']"

  if [ "${proname}" == "gnome" ]
  then
    profile_path="$dconfdir/:$profile_id"
  fi
  if [ "${proname}" == "tilix" ]
  then
    profile_path="$dconfdir/$profile_id"
  fi
  dconf write $profile_path/visible-name "'$profile_name'"

  # Asciiville profile wants a black background with no transparency
  dconf write $profile_path/background-color "'rgb(0,0,0)'"
  dconf write $profile_path/foreground-color "'rgb(255,255,255)'"
  dconf write $profile_path/cursor-shape "'underline'"
  dconf write $profile_path/cursor-blink-mode "'off'"
  dconf write $profile_path/use-theme-colors "false"
  if [ "${proname}" == "gnome" ]
  then
    dconf write $profile_path/use-theme-transparency "false"
    dconf write $profile_path/use-transparent-background "false"
  fi
  if [ "${proname}" == "tilix" ]
  then
    dconf write $profile_path/background-transparency-percent "0"
  fi
  # Do we need to set the font in the profile?
  # FONT="Monospace Regular"
  # SIZE=12
}

# If no gnome-terminal Asciiville profile exists, create one
declare -a profiles
profile_name="Asciiville"

profile_exists=
dconfdir=/org/gnome/terminal/legacy/profiles:

# profiles=($(gconftool-2 -R $gconfdir | grep $gconfdir | cut -d/ -f5 |  \
#          cut -d: -f1))
profiles=($(gsettings get org.gnome.Terminal.ProfilesList list | tr -d "[]\',"))

if [ "$profiles" = "" ]
then
  create_new_profile gnome
else
  for i in ${!profiles[*]}
  do
    if [[ "$(dconf read $dconfdir/:${profiles[i]}/visible-name)" == \
        "'$profile_name'" ]]
    then
      profile_exists=1
      break
    fi
  done
fi

[ "$profile_exists" ] || {
  # Create an Asciiville profile in gnome-terminal for this user
  create_new_profile gnome
}

# Create Asciiville Tilix profile, similar to Gnome-terminal's
profile_exists=
dconfdir=/com/gexperts/Tilix/profiles

profiles=($(gsettings get com.gexperts.Tilix.ProfilesList list | tr -d "[]\',"))

if [ "$profiles" = "" ]
then
  create_new_profile tilix
else
  for i in ${!profiles[*]}
  do
    if [[ "$(dconf read $dconfdir/${profiles[i]}/visible-name)" == \
        "'$profile_name'" ]]
    then
      profile_exists=1
      break
    fi
  done
fi

[ "$profile_exists" ] || {
  # Create an Asciiville profile in Tilix for this user
  create_new_profile tilix
}

printf "\n${BOLD}Asciiville Initialization Complete${NORMAL}\n"
printf "\nAuthorize the Rainbow Stream app at Twitter"
printf "\nby running the ${BOLD}'rainbowstream'${NORMAL} command\n"
printf "\nVisit the Asciiville Wiki at:"
printf "\n\t${BOLD}https://github.com/doctorfree/Asciiville/wiki${NORMAL}\n"

[ "$1" == "-n" ] || {
  type -p asciisplash > /dev/null && {
    while true
    do
      read -p "View an ASCII animation ? (y/n) " yn
      case $yn in
        [Yy]* )
              asciisplash -c 1 -a -i
              break
              ;;
        [Nn]* )
              printf "\nExiting.\n"
              exit 0
              ;;
            * ) echo "Please answer yes or no."
              ;;
      esac
    done
  }
}
